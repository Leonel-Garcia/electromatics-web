<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diseñador de Puesta a Tierra | Electromatics</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/grounding.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="main-header">
        <nav class="container">
            <a href="index.html" class="logo">
                <img src="images/logo.png" alt="Electromatics" style="height: 32px; margin-right: 10px;">
                <span>Electromatics</span>
            </a>
            <div class="desktop-nav">
                <a href="index.html">Inicio</a>
                <a href="calculos-electricos.html" class="active">Cálculos</a>
                <a href="simuladores.html">Simuladores</a>
                <a href="normativa-electrica.html">Normativa</a>
            </div>
        </nav>
    </header>

    <main class="container" style="margin-top: 40px;">
        <div class="grounding-dashboard">
            <h1 style="margin-bottom: 10px; color: var(--electric-blue);">
                <i class="fa-solid fa-earth-americas"></i> Diseñador de Puesta a Tierra
            </h1>
            <p style="margin-bottom: 30px; color: var(--text-secondary);">
                Herramienta profesional de cálculo y validación según FONDONORMA 200:2009 y IEEE Std 80.
            </p>

            <!-- HEADER: Project Details (New) -->
            <div class="calc-section" style="margin-bottom: 20px;">
                <div class="calc-header">
                    <h2><i class="fa-solid fa-folder-open"></i> Datos del Proyecto</h2>
                </div>
                <div class="input-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="form-group">
                        <label>Nombre del Proyecto</label>
                        <input type="text" id="proj-name" class="calc-input" placeholder="Ej. Subestación Principal">
                    </div>
                    <div class="form-group">
                        <label>Ubicación / Sitio</label>
                        <input type="text" id="proj-loc" class="calc-input" placeholder="Ej. Zona Industrial I">
                    </div>
                    <div class="form-group">
                        <label>Cliente / Empresa</label>
                        <input type="text" id="proj-client" class="calc-input" placeholder="Ej. Corpoelec">
                    </div>
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="proj-date" class="calc-input">
                    </div>
                </div>
            </div>

            <!-- Application Selector -->
            <div class="app-grid">
                <div class="app-card active" data-type="substation">
                    <i class="fa-solid fa-bolt"></i>
                    <h3>Subestación</h3>
                    <p>Mallas IEEE 80 (< 1 Ω)</p>
                </div>
                <div class="app-card" data-type="building">
                    <i class="fa-solid fa-building"></i>
                    <h3>Edificio</h3>
                    <p>Fondonorma 250.56 (< 25 Ω)</p>
                </div>
                <div class="app-card" data-type="industrial">
                    <i class="fa-solid fa-industry"></i>
                    <h3>Industrial</h3>
                    <p>Bta. Tensión (< 5 Ω)</p>
                </div>
                <div class="app-card" data-type="tank">
                    <i class="fa-solid fa-oil-well"></i>
                    <h3>Tanques / Oil</h3>
                    <p>API RP 2003 (< 10 Ω)</p>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                
                <!-- Left Column: Calculation Inputs -->
                <div class="calc-column">
                    
                    <!-- System Parameters (NEW) -->
                    <div class="calc-section">
                        <div class="calc-header">
                            <h2><i class="fa-solid fa-server"></i> Parámetros del Sistema</h2>
                        </div>
                        <div class="input-grid">
                            <div class="form-group">
                                <label>Voltaje Sistema (kV)</label>
                                <input type="number" id="sys-kv" class="calc-input" value="13.8" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>Corriente Falla (kA)</label>
                                <input type="number" id="sys-if" class="calc-input" value="10" step="1">
                            </div>
                            <div class="form-group">
                                <label>Tiempo Falla (s)</label>
                                <input type="number" id="sys-tf" class="calc-input" value="0.5" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- Soil Section -->
                    <div class="calc-section">
                        <div class="calc-header">
                            <h2><i class="fa-solid fa-layer-group"></i> Resistividad del Suelo</h2>
                            <small class="tag">Método Wenner (IEEE 81)</small>
                        </div>
                        <div class="input-grid">
                            <div class="form-group">
                                <label>Separación Electrodos (a) [m]</label>
                                <input type="number" id="wenner-a" class="calc-input" value="3" step="0.5">
                            </div>
                            <div class="form-group">
                                <label>Resistencia Leída (R) [Ω]</label>
                                <input type="number" id="wenner-r" class="calc-input" value="2" step="0.1">
                            </div>
                        </div>
                        <div class="result-card">
                            <small>Resistividad Aparente (ρ)</small>
                            <div class="result-value"><span id="res-rho">0</span> <span style="font-size: 1rem;">Ω·m</span></div>
                            <small style="color: var(--text-secondary); font-size: 0.8rem;">Ref: IEEE Std 81</small>
                        </div>
                    </div>

                    <!-- Design Parameters -->
                    <div class="calc-section">
                        <div class="calc-header">
                            <h2><i class="fa-solid fa-pencil"></i> Electrodos y Malla</h2>
                        </div>
                        
                        <h4 style="color: var(--text-secondary); margin-bottom: 10px;">Electrodo Vertical (Dwight)</h4>
                        <div class="input-grid">
                            <div class="form-group">
                                <label>Longitud (L) [m]</label>
                                <input type="number" id="rod-len" class="calc-input" value="2.44">
                                <small style="color: grey;">Mín 2.44m (CEN 250.52)</small>
                            </div>
                            <div class="form-group">
                                <label>Diámetro [pulg]</label>
                                <select id="rod-dia" class="calc-input">
                                    <option value="0.5">1/2"</option>
                                    <option value="0.625" selected>5/8"</option>
                                    <option value="0.75">3/4"</option>
                                </select>
                            </div>
                        </div>

                        <h4 style="color: var(--text-secondary); margin-bottom: 10px; margin-top: 20px;">Malla de Tierra (Sverak)</h4>
                        <div class="input-grid">
                            <div class="form-group">
                                <label>Área de Malla (A) [m²]</label>
                                <input type="number" id="grid-area" class="calc-input" value="100">
                            </div>
                            <div class="form-group">
                                <label>Longitud Conductor (Lt) [m]</label>
                                <input type="number" id="grid-len" class="calc-input" value="120">
                            </div>
                            <div class="form-group">
                                <label>Profundidad (h) [m]</label>
                                <input type="number" id="grid-depth" class="calc-input" value="0.5" step="0.1">
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Right Column: Results & Visualization -->
                <div class="results-column">
                    
                    <button id="btn-guide" class="btn btn-secondary" style="width: 100%; margin-bottom: 20px;">
                        <i class="fa-solid fa-circle-question"></i> Guía de Uso y Normativa
                    </button>

                    <!-- Conductor Sizing Result (NEW) -->
                    <div class="calc-section" style="border-left: 5px solid var(--warning-yellow);">
                        <div class="calc-header">
                            <h2><i class="fa-solid fa-ruler-combined"></i> Conductor de Tierra</h2>
                        </div>
                        <div style="margin-bottom: 10px;">
                           <small>Sección Mínima (Onderdonk / IEEE 80)</small>
                           <div class="result-value" id="res-conductor" style="color: var(--warning-yellow);">0 mm²</div>
                           <div id="res-conductor-awg" style="font-weight: bold; color: var(--text-primary); margin-top: 5px;">-</div>
                        </div>
                         <small style="color: var(--text-secondary); font-size: 0.85em;">
                            Basado en capacidad térmica para Icc=<span id="lbl-icc">0</span>kA, t=<span id="lbl-time">0</span>s. (IEEE 80 Sec. 11.3)
                        </small>
                    </div>

                    <!-- Design Suggestions (NEW) -->
                    <div class="calc-section" id="suggestion-card" style="border-left: 5px solid var(--success-green); display: none;">
                        <div class="calc-header">
                            <h2><i class="fa-solid fa-lightbulb"></i> Diseño Sugerido</h2>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <small style="color: var(--text-secondary);">Para cumplir con <span id="sugg-target">25 Ω</span>:</small>
                            <div id="sugg-content" style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-top: 5px;">
                                <!-- Dynamic Content -->
                            </div>
                        </div>
                        <div id="sugg-details" style="font-size: 0.9rem; color: var(--text-secondary); background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                            <!-- Extra details (e.g. conductor length) -->
                        </div>
                    </div>

                    <!-- Compliance Panel -->
                    <div class="calc-section" style="border-left: 5px solid var(--electric-blue);">
                        <div class="calc-header">
                            <h2><i class="fa-solid fa-clipboard-check"></i> Conformidad</h2>
                        </div>
                        
                        <!-- MAIN RESULT DISPLAY (NEW) -->
                        <div style="text-align: center; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                            <small id="res-label" style="text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary);">Resistencia Calculada</small>
                            <div style="font-size: 3rem; font-weight: bold; color: var(--electric-blue); margin: 5px 0;">
                                <span id="res-main">0.00</span> Ω
                            </div>
                            <div id="compliance-badge" class="compliance-badge compliance-pass">
                                <i class="fa-solid fa-check"></i> CUMPLE NORMA
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                            <div>
                                <small>Límite Normativo</small>
                                <div id="target-resistance" style="font-size: 1.2rem; font-weight: bold; color: var(--text-primary);">25 Ω</div>
                            </div>
                            <div style="text-align: right;">
                                <small>Norma Referencia</small>
                                <div id="standard-ref" style="font-size: 0.9rem; color: var(--text-secondary);">Fondonorma 250</div>
                            </div>
                        </div>

                        <table class="grounding-table">
                            <thead>
                                <tr>
                                    <th>Detalles de Cálculo</th>
                                    <th>Valor (R)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Varilla (Dwight)</td>
                                    <td>
                                        <strong id="res-rod" style="color: var(--text-primary);">0</strong> Ω
                                        <div style="font-size: 0.75em; color: var(--text-secondary);">IEEE 142</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Malla (Sverak)</td>
                                    <td>
                                        <strong id="res-grid" style="color: var(--text-primary);">0</strong> Ω
                                        <div style="font-size: 0.75em; color: var(--text-secondary);">IEEE 80</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Visualization -->
                    <div class="calc-section">
                        <div class="calc-header">
                            <h2><i class="fa-solid fa-chart-area"></i> Perfil de Resistividad</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="resistivityChart"></canvas>
                        </div>
                    </div>

                    <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="Grounding.generatePDF()">
                        <i class="fa-solid fa-file-pdf"></i> Generar Memoria de Cálculo
                    </button>

                </div>
            </div>
        </div>

        <!-- Usage Guide Modal -->
        <div id="guide-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2 style="color: var(--electric-blue); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px;">
                    <i class="fa-solid fa-book"></i> Guía de Uso del Diseñador
                </h2>
                
                <div style="overflow-y: auto; max-height: 60vh; padding-right: 10px;">
                    <h3 style="color: var(--text-primary); margin-top: 0;">1. Objetivo</h3>
                    <p>Diseñar y validar sistemas de puesta a tierra seguros y normativos. Esta herramienta permite verificar si la resistencia a tierra cumple con los límites establecidos en <strong>FONDONORMA 200:2009 (CEN)</strong> e <strong>IEEE Std 80</strong>.</p>

                    <h3>2. Datos de Entrada Requeridos</h3>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><strong>Parámetros del Sistema:</strong> Voltaje (kV), Corriente de Falla (kA) y Tiempo de despeje (s). Críticos para dimensionar el conductor.</li>
                        <li><strong>Resistividad del Suelo:</strong> Datos obtenidos por el método de Wenner (separación 'a' y resistencia 'R').</li>
                        <li><strong>Geometría:</strong> Dimensiones de varillas o de la malla de tierra propuesta.</li>
                    </ul>

                    <h3>3. Interpretación de Resultados</h3>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <p><strong><i class="fa-solid fa-check" style="color: var(--success-green);"></i> CUMPLE NORMA:</strong></p>
                        <p>La resistencia calculada es menor al límite exigido para la aplicación seleccionada:</p>
                        <ul style="margin-top: 5px;">
                            <li><strong>Subestaciones:</strong> < 1.0 Ω (Típico IEEE 80)</li>
                            <li><strong>Edificaciones:</strong> < 25.0 Ω (CEN Art. 250.56)</li>
                            <li><strong>Industrial:</strong> < 5.0 Ω (Práctica recomendada)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/grounding.js"></script>
    <!-- jsPDF Libraries for Reporting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
